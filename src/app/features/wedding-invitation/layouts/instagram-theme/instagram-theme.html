<div class="ig-container">

  @if (activeStory) {
  <div class="ig-story-overlay" [class.specific-story]="activeStory !== 'cover'" (click)="onOverlayClick($event)">

    <div class="ig-story-bg" [style.backgroundImage]="getStoryBackgroundImage(activeStory)"></div>

    <div class="ig-story-header">
      <div class="progress-bars">
        <div class="bar">
          <div class="fill" [style.width.%]="storyProgress"></div>
        </div>
      </div>

      <div class="user-info">
        <img [src]="getImageUrl(invitation.bride_photo) || 'assets/images/bride-placeholder.jpg'" class="avatar"
          alt="Avatar" />
        <span class="username">{{ invitation.groom_name }} & {{ invitation.bride_name }}</span>
        <span class="time">
          @if(activeStory === 'cover') { Sponsored }
          @else if(activeStory === 'event') { The Day }
          @else if(activeStory === 'gallery') { Memories }
        </span>
        <i class="fas fa-times ms-auto text-white close-icon" (click)="closeStory(); $event.stopPropagation()"></i>
      </div>
    </div>

    <div class="ig-story-content">

      @if (activeStory === 'cover') {
      <div class="glass-box">
        <p class="to-label">Dear,</p>
        <h2 class="guest-name">{{ formattedGuestName }}</h2>

        <div class="wedding-title-box">
          <span>THE WEDDING OF</span>
          <h3>{{ invitation.groom_name }} & {{ invitation.bride_name }}</h3>
        </div>

        <div class="tap-hint mt-3">
          <span>Tap to Open <i class="fas fa-chevron-right"></i></span>
        </div>
      </div>
      }

      @else if (activeStory === 'event') {
      <div class="glass-box text-left">
        <h3 class="story-title">The Wedding Day</h3>
        <div class="mb-3">
          <strong class="label-red">TANGGAL</strong><br>
          {{ invitation.wedding_date | date:'EEEE, d MMMM y' }}
        </div>
        <div class="mb-3">
          <strong class="label-red">LOKASI AKAD</strong><br>
          <small>{{ invitation.akad_location }}</small>
        </div>
        <div class="mb-3">
          <strong class="label-red">LOKASI RESEPSI</strong><br>
          <small>{{ invitation.reception_location }}</small>
        </div>
      </div>
      }

      @else if (activeStory === 'gallery') {
      <div class="tap-guide">Tap for next photo <i class="fas fa-hand-pointer"></i></div>
      }
    </div>

    <div class="ig-story-footer" (click)="$event.stopPropagation()">
      <div class="reply-box">Send message...</div>
      <i class="far fa-heart"></i>
      <i class="far fa-paper-plane"></i>
    </div>
  </div>
  }

  @if (!activeStory) {
  <main class="ig-feed" #contentContainer>
    <nav class="ig-navbar">
      <div class="logo">The Wedding</div>
      <div class="actions">
        <i class="far fa-heart"></i>
        <i class="far fa-paper-plane"></i>
      </div>
    </nav>

    <div class="ig-stories-bar">
      <div class="story-item" (click)="openSpecificStory('gallery')">
        <div class="ring"><img [src]="getImageUrl(invitation.gallery[0]?.filename) || 'assets/images/default.jpg'"
            alt="Memories" /></div>
        <span>Memories</span>
      </div>
      <div class="story-item" (click)="openSpecificStory('event')">
        <div class="ring"><img [src]="getImageUrl(invitation.groom_photo) || 'assets/images/groom-placeholder.jpg'"
            alt="The Day" /></div>
        <span>The Day</span>
      </div>
    </div>

    <article class="ig-post" id="coupleSection">
      <header>
        <img [src]="getImageUrl(invitation.bride_photo) || 'assets/images/bride-placeholder.jpg'" class="avatar"
          alt="Ava" />
        <div class="info"><span class="username">{{ invitation.groom_name | lowercase }}_official</span><span
            class="location">Bridal Chamber</span></div>
        <i class="fas fa-ellipsis-h ms-auto"></i>
      </header>
      <div class="post-image">
        <img [src]="getImageUrl(invitation.gallery[0]?.filename) || 'assets/images/default.jpg'" alt="Main Post" />
      </div>
      <div class="actions">
        <div class="left"><i class="far fa-heart"></i><i class="far fa-comment"></i></div><i
          class="far fa-bookmark ms-auto"></i>
      </div>
      <div class="content">
        <p class="likes">Liked by <b>keluarga.besar</b> and <b>others</b></p>
        <p class="caption">
          <span class="username">{{ invitation.groom_name }} & {{ invitation.bride_name }}</span>
          Assalamu‚Äôalaikum. Kepada <b>{{ formattedGuestName }}</b>, kami memohon doa restu. üíç
        </p>
      </div>
    </article>

    <article class="ig-post" id="eventSection">
      <header>
        <img [src]="getImageUrl(invitation.groom_photo) || 'assets/images/groom-placeholder.jpg'" class="avatar"
          alt="Ava" />
        <div class="info"><span class="username">save.the.date</span></div>
      </header>
      <div class="post-content-box carousel-container">
        <div class="carousel-wrapper text-carousel" (scroll)="onEventScroll($event)">
          <div class="carousel-item">
            <div class="details text-center">
              <div class="date-display">
                <span class="month">{{ invitation.wedding_date | date:'MMM' }}</span>
                <span class="day">{{ invitation.wedding_date | date:'dd' }}</span>
                <span class="year">{{ invitation.wedding_date | date:'yyyy' }}</span>
              </div>
              <app-countdown-timer [targetDate]="invitation.wedding_date"></app-countdown-timer>
            </div>
          </div>
          <div class="carousel-item">
            <div class="details text-center event-card-slide">
              <h4 class="event-title">üíç AKAD NIKAH</h4>
              <p class="event-time">08:00 WIB - 10:00 WIB</p>
              <p class="event-loc">{{ invitation.akad_location }}</p>
              <a [href]="invitation.akad_map_url" target="_blank" class="ig-btn-link">View Maps</a>
            </div>
          </div>
          <div class="carousel-item">
            <div class="details text-center event-card-slide">
              <h4 class="event-title">üéâ RESEPSI</h4>
              <p class="event-time">11:00 WIB - Selesai</p>
              <p class="event-loc">{{ invitation.reception_location }}</p>
              <a [href]="invitation.reception_map_url" target="_blank" class="ig-btn-link">View Maps</a>
            </div>
          </div>
        </div>
        <div class="carousel-dots dark-dots">
          <div class="dot" [class.active]="activeEventSlideIndex === 0"></div>
          <div class="dot" [class.active]="activeEventSlideIndex === 1"></div>
          <div class="dot" [class.active]="activeEventSlideIndex === 2"></div>
        </div>
      </div>
      <div class="actions">
        <div class="left"><i class="far fa-heart"></i></div><i class="far fa-bookmark ms-auto"></i>
      </div>
    </article>

    <article class="ig-post" id="gallerySection">
      <header>
        <img [src]="getImageUrl(invitation.bride_photo) || 'assets/images/bride-placeholder.jpg'" class="avatar"
          alt="Ava" />
        <div class="info"><span class="username">our.memories</span></div>
      </header>
      <div class="carousel-container">
        <div class="carousel-wrapper" (scroll)="onGalleryScroll($event)">
          @for (photo of invitation.gallery; track photo.id) {
          <div class="carousel-item"><img [src]="getImageUrl(photo.filename)" alt="Gallery Photo" /></div>
          }
        </div>
        <div class="carousel-dots">
          @for (photo of invitation.gallery; track photo.id; let i = $index) {
          @if (invitation.gallery.length > 1) { <div class="dot" [class.active]="i === activeGalleryIndex"></div> }
          }
        </div>
      </div>
      <div class="actions">
        <div class="left"><i class="far fa-heart"></i></div><i class="far fa-bookmark ms-auto"></i>
      </div>
    </article>

    <article class="ig-post mb-5" id="rsvpSection">
      <header>
        <img [src]="getImageUrl(invitation.bride_photo) || 'assets/images/bride-placeholder.jpg'" class="avatar"
          alt="Ava" />
        <div class="info"><span class="username">wedding.wishes</span></div>
      </header>

      <div class="content p-3">
        <div class="ig-action-section mb-3">
          <p class="caption mb-2">
            <span class="username">wedding.wishes</span> Kehadiran Anda adalah hadiah terindah bagi kami.
          </p>
          <div class="action-buttons-grid">
            <div class="gift-box-clean">
              <span class="label">Wedding Gift</span>
              <app-digital-angpao></app-digital-angpao>
            </div>
          </div>
        </div>

        <hr class="ig-divider-thin" />
        <h4 class="comment-section-title">Konfirmasi Kehadiran</h4>
        <app-rsvp-form [slug]="invitation.slug"></app-rsvp-form>

        <hr class="ig-divider-thin" />
        <h4 class="comment-section-title">Comments</h4>
        <div class="ig-comments-wrapper">
          <app-guestbook [slug]="invitation.slug" [comments]="invitation.guestbooks"></app-guestbook>
        </div>
      </div>
    </article>
  </main>

  <nav class="ig-bottom-nav">
    <i class="fas fa-home active" (click)="scrollToSection('coupleSection')"></i>
    <i class="fas fa-search"></i>
    <i class="far fa-plus-square"></i>
    <i class="far fa-heart"></i>
    <img [src]="getImageUrl(invitation.bride_photo) || 'assets/images/bride-placeholder.jpg'" class="mini-avatar"
      alt="Profile" />
  </nav>

  <div class="music-control" (click)="toggleMusic()" [class.paused]="!isMusicPlaying">
    <div class="cd-disc">
      <div class="cd-inner"></div><img
        [src]="getImageUrl(invitation.gallery[0]?.filename) || 'assets/images/default.jpg'" alt="Album Cover"
        class="cd-cover" />
    </div>
  </div>
  }
</div>