<div class="ig-container">

  @if (activeStory) {
  <div class="ig-story-overlay"
       [class.specific-story]="activeStory !== 'cover'"
       (click)="closeStory()">

    <div
      class="ig-story-bg"
      [style.backgroundImage]="getStoryBackgroundImage(activeStory)"
    ></div>

    <div class="ig-story-header">
      @if (activeStory === 'cover') {
      <div class="progress-bars">
        <div class="bar">
          <div class="fill" [style.width.%]="storyProgress"></div>
        </div>
      </div>
      }

      <div class="user-info">
        <img
          [src]="getImageUrl(invitation.bride_photo) || 'assets/images/bride-placeholder.jpg'"
          class="avatar"
          alt="Avatar"
        />
        <span class="username">
          {{ invitation.groom_name }} & {{ invitation.bride_name }}
        </span>
        <span class="time">
            @if(activeStory === 'cover') { Sponsored }
            @else if(activeStory === 'couple') { Couple Story }
            @else if(activeStory === 'event') { Event Details }
            @else { Highlights }
        </span>
        @if (activeStory !== 'cover') {
           <i class="fas fa-times ms-auto text-white" style="font-size: 24px;"></i>
        } @else {
           <i class="fas fa-ellipsis-h ms-auto text-white"></i>
        }
      </div>
    </div>

    @if (activeStory === 'cover') {
    <div class="ig-story-content">
      <div class="glass-box">
        <p>Dear,</p>
        <h2>{{ formattedGuestName | titlecase }}</h2>
        <div class="mt-3">
          <small style="color: white; display: block; margin-bottom: 5px">Menuju Halal:</small>
          <app-countdown-timer [targetDate]="invitation.wedding_date"></app-countdown-timer>
        </div>
        <span class="tap-hint mt-3 d-block">
          Tap to open <i class="fas fa-chevron-right"></i>
        </span>
      </div>
    </div>
    }
    @else {
        <div class="ig-story-content"></div>
    }

    <div class="ig-story-footer">
      <div class="reply-box">Send message...</div>
      <i class="far fa-heart"></i>
      <i class="far fa-paper-plane"></i>
    </div>
  </div>
  }

  @if (!activeStory) {
  <main class="ig-feed" #contentContainer>
    <nav class="ig-navbar">
      <div class="logo">The Wedding</div>
      <div class="actions">
        <i class="far fa-heart"></i>
        <i class="far fa-paper-plane"></i>
      </div>
    </nav>

    <div class="ig-stories-bar">
      <div class="story-item" (click)="openSpecificStory('couple')">
        <div class="ring">
          <img [src]="getImageUrl(invitation.bride_photo) || 'assets/images/bride-placeholder.jpg'" alt="Couple" />
        </div>
        <span>Couple</span>
      </div>
      <div class="story-item" (click)="openSpecificStory('event')">
        <div class="ring">
          <img [src]="getImageUrl(invitation.groom_photo) || 'assets/images/groom-placeholder.jpg'" alt="Event" />
        </div>
        <span>Event</span>
      </div>
      <div class="story-item" (click)="openSpecificStory('gallery')">
        <div class="ring"><i class="fas fa-images"></i></div>
        <span>Gallery</span>
      </div>
      <div class="story-item" (click)="openSpecificStory('rsvp')">
        <div class="ring"><i class="fas fa-envelope-open-text"></i></div>
        <span>RSVP</span>
      </div>
    </div>

    <article class="ig-post" id="coupleSection">
      <header>
        <img [src]="getImageUrl(invitation.bride_photo) || 'assets/images/bride-placeholder.jpg'" class="avatar" alt="Ava" />
        <div class="info">
          <span class="username">{{ invitation.groom_name | lowercase }}_official</span>
          <span class="location">Bridal Chamber</span>
        </div>
        <i class="fas fa-ellipsis-h ms-auto"></i>
      </header>
      <div class="post-image">
        <img [src]="getImageUrl(invitation.gallery[0]?.filename) || 'assets/images/default.jpg'" alt="Main Post" />
      </div>
      <div class="actions">
        <div class="left">
          <i class="far fa-heart"></i><i class="far fa-comment"></i><i class="far fa-paper-plane"></i>
        </div>
        <i class="far fa-bookmark ms-auto"></i>
      </div>
      <div class="content">
        <p class="likes">Liked by <b>keluarga.besar</b> and <b>others</b></p>
        <p class="caption">
          <span class="username">{{ invitation.groom_name }}</span> Bismillah, mohon doa restu. üíç
        </p>
        <p class="time">{{ invitation.wedding_date | date:'longDate' }}</p>
      </div>
    </article>

    <article class="ig-post" id="eventSection">
      <header>
        <img [src]="getImageUrl(invitation.groom_photo) || 'assets/images/groom-placeholder.jpg'" class="avatar" alt="Ava" />
        <div class="info"><span class="username">save.the.date</span></div>
      </header>
      <div class="post-content-box">
        <div class="date-display">
          <span class="month">{{ invitation.wedding_date | date:'MMM' }}</span>
          <span class="day">{{ invitation.wedding_date | date:'dd' }}</span>
          <span class="year">{{ invitation.wedding_date | date:'yyyy' }}</span>
        </div>
        <div class="details text-center">
          <app-countdown-timer [targetDate]="invitation.wedding_date"></app-countdown-timer>
          <hr class="post-hr" />
          <p><i class="fas fa-map-marker-alt"></i> {{ invitation.akad_location }}</p>
          <a [href]="invitation.akad_map_url" target="_blank" class="ig-btn-link">View on Maps</a>
        </div>
      </div>
      <div class="actions"><div class="left"><i class="far fa-heart"></i></div><i class="far fa-bookmark ms-auto"></i></div>
    </article>

    <article class="ig-post" id="gallerySection">
      <header>
        <img [src]="getImageUrl(invitation.bride_photo) || 'assets/images/bride-placeholder.jpg'" class="avatar" alt="Ava" />
        <div class="info"><span class="username">our.memories</span><span class="location">Everywhere</span></div>
      </header>
      <div class="carousel-container">
        <div class="carousel-wrapper" (scroll)="onGalleryScroll($event)">
          @for (photo of invitation.gallery; track photo.id) {
          <div class="carousel-item"><img [src]="getImageUrl(photo.filename)" alt="Gallery Photo" /></div>
          }
        </div>
        <div class="carousel-dots">
          @for (photo of invitation.gallery; track photo.id; let i = $index) {
            @if (invitation.gallery.length > 1) { <div class="dot" [class.active]="i === activeGalleryIndex"></div> }
          }
        </div>
      </div>
      <div class="actions"><div class="left"><i class="far fa-heart"></i></div><i class="far fa-bookmark ms-auto"></i></div>
      <div class="content"><p class="caption"><span class="username">our.memories</span> Momen indah perjalanan cinta kami. üì∏‚ú®</p></div>
    </article>

    <article class="ig-post mb-5" id="rsvpSection">
      <header>
        <img [src]="getImageUrl(invitation.bride_photo) || 'assets/images/bride-placeholder.jpg'" class="avatar" alt="Ava" />
        <div class="info"><span class="username">wedding.wishes</span></div>
      </header>
      <div class="content p-3">
        <div class="gift-box mb-3"><h3>Wedding Gift</h3><app-digital-angpao></app-digital-angpao></div>
        <hr class="ig-divider" /><h4 class="section-title">Konfirmasi Kehadiran</h4><app-rsvp-form></app-rsvp-form>
        <hr class="ig-divider" /><h4 class="section-title">Comments</h4>
        <app-guestbook [slug]="invitation.slug" [comments]="invitation.guestbooks"></app-guestbook>
      </div>
    </article>
  </main>

  <nav class="ig-bottom-nav">
    <i class="fas fa-home active" (click)="scrollToSection('coupleSection')"></i>
    <i class="fas fa-search"></i>
    <i class="far fa-plus-square"></i>
    <i class="far fa-heart"></i>
    <img [src]="getImageUrl(invitation.bride_photo) || 'assets/images/bride-placeholder.jpg'" class="mini-avatar" alt="Profile" />
  </nav>

  <div class="music-control" (click)="toggleMusic()" [class.paused]="!isMusicPlaying">
    <div class="cd-disc"><div class="cd-inner"></div><img [src]="getImageUrl(invitation.gallery[0]?.filename) || 'assets/images/default.jpg'" alt="Album Cover" class="cd-cover" /></div>
    <div class="music-notes"><i class="fas fa-music note-1"></i><i class="fas fa-music note-2"></i></div>
  </div>
  }

  @if (youtubeEmbedUrl && isMusicPlaying) {
  <div class="youtube-hidden">
    <iframe #youtubePlayer id="youtubePlayer" [src]="youtubeEmbedUrl" allow="autoplay; encrypted-media;" allowfullscreen></iframe>
  </div>
  }
</div>
